"use strict";(globalThis.webpackChunkGATK_SV=globalThis.webpackChunkGATK_SV||[]).push([[9872],{1470(e,n,t){t.d(n,{A:()=>w});var s=t(6540),r=t(4164),i=t(3104),o=t(6347),a=t(205),l=t(7485),c=t(1682),d=t(679);function u(e){return s.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,s.useMemo)(()=>{const e=n??function(e){return u(e).map(({props:{value:e,label:n,attributes:t,default:s}})=>({value:e,label:n,attributes:t,default:s}))}(t);return function(e){const n=(0,c.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,t])}function p({value:e,tabValues:n}){return n.some(n=>n.value===e)}function g({queryString:e=!1,groupId:n}){const t=(0,o.W6)(),r=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(r),(0,s.useCallback)(e=>{if(!r)return;const n=new URLSearchParams(t.location.search);n.set(r,e),t.replace({...t.location,search:n.toString()})},[r,t])]}function m(e){const{defaultValue:n,queryString:t=!1,groupId:r}=e,i=h(e),[o,l]=(0,s.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!p({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find(e=>e.default)??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:i})),[c,u]=g({queryString:t,groupId:r}),[m,x]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,r]=(0,d.Dv)(n);return[t,(0,s.useCallback)(e=>{n&&r.set(e)},[n,r])]}({groupId:r}),j=(()=>{const e=c??m;return p({value:e,tabValues:i})?e:null})();(0,a.A)(()=>{j&&l(j)},[j]);return{selectedValue:o,selectValue:(0,s.useCallback)(e=>{if(!p({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),x(e)},[u,x,i]),tabValues:i}}var x=t(2303);const j="tabList__CuJ",f="tabItem_LNqP";var y=t(4848);function b({className:e,block:n,selectedValue:t,selectValue:s,tabValues:o}){const a=[],{blockElementScrollPositionUntilNextRender:l}=(0,i.a_)(),c=e=>{const n=e.currentTarget,r=a.indexOf(n),i=o[r].value;i!==t&&(l(n),s(i))},d=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const t=a.indexOf(e.currentTarget)+1;n=a[t]??a[0];break}case"ArrowLeft":{const t=a.indexOf(e.currentTarget)-1;n=a[t]??a[a.length-1];break}}n?.focus()};return(0,y.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":n},e),children:o.map(({value:e,label:n,attributes:s})=>(0,y.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{a.push(e)},onKeyDown:d,onClick:c,...s,className:(0,r.A)("tabs__item",f,s?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function v({lazy:e,children:n,selectedValue:t}){const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=i.find(e=>e.props.value===t);return e?(0,s.cloneElement)(e,{className:(0,r.A)("margin-top--md",e.props.className)}):null}return(0,y.jsx)("div",{className:"margin-top--md",children:i.map((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function k(e){const n=m(e);return(0,y.jsxs)("div",{className:(0,r.A)("tabs-container",j),children:[(0,y.jsx)(b,{...n,...e}),(0,y.jsx)(v,{...n,...e})]})}function w(e){const n=(0,x.A)();return(0,y.jsx)(k,{...e,children:u(e.children)},String(n))}},8453(e,n,t){t.d(n,{R:()=>o,x:()=>a});var s=t(6540);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}},9302(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>u});const s=JSON.parse('{"id":"advanced/docker/manual","title":"Manual Deployment","description":"Build and Publish Images","source":"@site/docs/advanced/docker/manual.md","sourceDirName":"advanced/docker","slug":"/advanced/docker/manual","permalink":"/gatk-sv/docs/advanced/docker/manual","draft":false,"unlisted":false,"editUrl":"https://github.com/broadinstitute/gatk-sv/tree/master/website/docs/advanced/docker/manual.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Manual Deployment","description":"Build and Publish Images","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Automated Deployment","permalink":"/gatk-sv/docs/advanced/docker/automated"},"next":{"title":"Image Dependencies","permalink":"/gatk-sv/docs/advanced/docker/dependencies"}}');var r=t(4848),i=t(8453),o=t(1470),a=t(9365);const l={title:"Manual Deployment",description:"Build and Publish Images",sidebar_position:3},c=void 0,d={},u=[{value:"Setup an Ubuntu VM",id:"setup-an-ubuntu-vm",level:2},{value:"1. Set environment variables",id:"1-set-environment-variables",level:4},{value:"2. Create an Ubuntu VM",id:"2-create-an-ubuntu-vm",level:4},{value:"3. Connect to the VM",id:"connect-to-vm",level:4},{value:"4. Install Docker",id:"docker",level:4},{value:"Checkout codebase",id:"checkout",level:2},{value:"Build and Publish Docker Images",id:"build",level:2},{value:"<code>--targets</code>",id:"targets",level:3},{value:"<code>--image-tag</code>",id:"tag",level:3},{value:"<code> --docker-repo</code>",id:"registry",level:3},{value:"Post-build",id:"post-build",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{Details:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"If you contribute to the GATK-SV codebase, we recommend you ensure that affected Docker images build successfully and function as intended. The process involves two steps:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Build"}),": Create Docker images from Dockerfiles."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Publish"}),": Upload the built Docker images to container registries\n(e.g., Google or Azure container registries, GCR and ACR, respectively)\nto make them available for use in Terra or Cromwell.\n",(0,r.jsx)(n.em,{children:"You may skip this step unless you would like to host the images you built on your own container registry."})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["To streamline the process, we have developed a\n",(0,r.jsx)(n.a,{href:"https://github.com/broadinstitute/gatk-sv/blob/main/scripts/docker/build_docker.py",children:"script"}),"\nthat automates both the build and publish steps.\nThis section provides guidelines on setting up the environment and running the\nscript with a minimal example."]}),"\n",(0,r.jsx)(n.admonition,{title:"x86 Linux Machine Required",type:"danger",children:(0,r.jsx)(n.p,{children:"Only Linux machines (dedicated or virtual) are supported for building GATK-SV Docker images.\nIn addition, images created on non-Intel processor architectures (e.g., Apple M1) may not function as intended,\neven if the build process runs successfully."})}),"\n",(0,r.jsx)(n.h2,{id:"setup-an-ubuntu-vm",children:"Setup an Ubuntu VM"}),"\n",(0,r.jsxs)(n.p,{children:["This section outlines steps to follow in order to\ncreate and connect to a Linux virtual machine (VM)\non a cloud service provider.\nYou may ",(0,r.jsx)(n.a,{href:"#checkout",children:"skip to the next section"})," if you are using a dedicated Linux machine\n(e.g., a laptop running Ubuntu)."]}),"\n",(0,r.jsx)(n.h4,{id:"1-set-environment-variables",children:"1. Set environment variables"}),"\n",(0,r.jsx)(o.A,{groupId:"cloud",defaultValue:"gcp",values:[{label:"GCP",value:"gcp"}],children:(0,r.jsx)(a.A,{value:"gcp",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'export PROJECT_ID="<GOOGLE PROJECT ID>"\nexport ZONE_ID="<ZONE ID>"\n\n# Make sure no machine with the following name exist,\n# and you follow VM naming conventions, e.g., all lower-case characters.\nexport INSTANCE_NAMES="<VM NAME>"\n'})})})}),"\n",(0,r.jsx)(n.h4,{id:"2-create-an-ubuntu-vm",children:"2. Create an Ubuntu VM"}),"\n",(0,r.jsxs)(n.p,{children:["You may ",(0,r.jsx)(n.a,{href:"#connect-to-vm",children:"skip to the next step"})," if you have already created a VM."]}),"\n",(0,r.jsx)(o.A,{groupId:"cloud",defaultValue:"gcp",values:[{label:"GCP",value:"gcp"}],children:(0,r.jsxs)(a.A,{value:"gcp",children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gcloud compute instances create $INSTANCE_NAMES \\\n  --project=$PROJECT_ID \\\n  --zone=$ZONE_ID \\\n  --machine-type=e2-standard-2 \\\n  --create-disk=auto-delete=yes,boot=yes,device-name=$INSTANCE_NAMES,image=projects/ubuntu-os-cloud/global/images/ubuntu-2310-mantic-amd64-v20240213,mode=rw,size=100\n"})}),(0,r.jsxs)(n.p,{children:["Note that this command creates a VM with ",(0,r.jsx)(n.code,{children:"100 GiB"})," disk size,\nto accommodate for the disk space requirements of GATK-SV Docker images."]}),(0,r.jsxs)(n.p,{children:["You may follow the documentation on\n",(0,r.jsx)(n.a,{href:"https://cloud.google.com/compute/docs/instances/create-start-instance#publicimage",children:"this page"}),"\nfor more details on creating a virtual machine on GCP."]})]})}),"\n",(0,r.jsxs)(n.admonition,{type:"tip",children:[(0,r.jsx)(n.mdxAdmonitionTitle,{}),(0,r.jsx)(n.p,{children:"The firewall rules of your institute may require you to be on-site or connected\nto the institute's VPN before you can access the cloud resources billed to your institute."})]}),"\n",(0,r.jsx)(n.h4,{id:"connect-to-vm",children:"3. Connect to the VM"}),"\n",(0,r.jsx)(o.A,{groupId:"cloud",defaultValue:"gcp",values:[{label:"GCP",value:"gcp"}],children:(0,r.jsxs)(a.A,{value:"gcp",children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gcloud compute ssh $INSTANCE_NAMES --project $PROJECT_ID\n"})}),(0,r.jsxs)(n.p,{children:["Follow the on-screen prompts for authorizing access to ",(0,r.jsx)(n.code,{children:"ssh"})," credentials."]}),(0,r.jsxs)(t,{children:[(0,r.jsx)("summary",{children:"Errors running this command"}),(0,r.jsxs)("div",{children:[(0,r.jsx)(n.p,{children:"If you are getting any of the following error messages when you try\nto connect to the VM immediately after you have created it,\nit may indicate that the VM is not ready yet, and you may need to\nwait a few minutes before retrying."}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ssh: connect to host [IP address] port 22: Connection refused\n"})}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ERROR: (gcloud.compute.ssh) [/usr/bin/ssh] exited with return code [255].\nusername@[IP address]: Permission denied (publickey).\n"})})]})]})]})}),"\n",(0,r.jsx)(n.h4,{id:"docker",children:"4. Install Docker"}),"\n",(0,r.jsxs)(n.p,{children:["You may ",(0,r.jsx)(n.a,{href:"#checkout",children:"skip to the next step"})," if you have already installed and configured Docker on this VM."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Install pre-requisites"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'sudo apt-get update && \\\nsudo apt-get install ca-certificates curl && \\\nsudo install -m 0755 -d /etc/apt/keyrings && \\\nsudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc && \\\nsudo chmod a+r /etc/apt/keyrings/docker.asc && \\\necho \\\n  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \\\n  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \\\n  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null && \\\nsudo apt-get update\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Install Docker"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo apt-get -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin && \\\nsudo usermod -aG docker ${USER} && \\\nnewgrp docker\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You may follow ",(0,r.jsx)(n.a,{href:"https://docs.docker.com/engine/install/ubuntu/",children:"Docker documentation"}),"\non details on installed Docker on Ubuntu."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Login to Docker"}),"\n",(0,r.jsx)(o.A,{groupId:"cloud",defaultValue:"gcp",values:[{label:"GCP",value:"gcp"}],children:(0,r.jsxs)(a.A,{value:"gcp",children:[(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Run the following command on the VM."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gcloud auth login\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Follow the on-screen prompts, it will display a URL that you need to copy-paste it\non the browser of your computer (",(0,r.jsx)(n.em,{children:"not"})," the VM)."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Follow the prompts on your browser, and login with an account that will provide you\nwith access to the GCR repository. If you are planning on ",(0,r.jsx)(n.em,{children:"publishing"})," images you\nbuild to GCR, you need to make sure you account has ",(0,r.jsx)(n.a,{href:"https://cloud.google.com/artifact-registry/docs/docker/pushing-and-pulling#required_roles",children:"sufficient access"}),"\nto GCR."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Configure Docker with your credentials."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"gcloud auth configure-docker\n"})}),"\n"]}),"\n"]}),(0,r.jsxs)(n.p,{children:["You may refer to ",(0,r.jsx)(n.a,{href:"https://cloud.google.com/artifact-registry/docs/docker/authentication",children:"this page"}),"\nfor more details on configure Docker to access GCR."]})]})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"checkout",children:"Checkout codebase"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Clone the repository or its fork that contains the branch with the changes\nthat you want to build the Docker images based-off."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"git clone https://github.com/broadinstitute/gatk-sv && cd gatk-sv\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Checkout the branch containing your changes."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"git checkout <BRANCH_NAME>\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"build",children:"Build and Publish Docker Images"}),"\n",(0,r.jsxs)(n.p,{children:["In its minimal setup, you may use the following command to ",(0,r.jsx)(n.strong,{children:"build and publish"})," GATK-SV Docker images."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"python3 scripts/docker/build_docker.py \\\n    --targets <IMAGES> \\\n    --image-tag <TAG> \\\n    --docker-repo <CONTAINER_REGISTRY>\n"})}),"\n",(0,r.jsx)(n.p,{children:"The arguments are explained in the following."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#targets",children:(0,r.jsx)(n.code,{children:"--targets"})})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#tag",children:(0,r.jsx)(n.code,{children:"--image-tag"})})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#registry",children:(0,r.jsx)(n.code,{children:"--docker-repo"})})}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"targets",children:(0,r.jsx)(n.code,{children:"--targets"})}),"\n",(0,r.jsx)(n.p,{children:"You may follow either of the following approaches to determine which images to rebuild."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Manual:"}),"\nYou may refer to the table in ",(0,r.jsx)(n.a,{href:"./dependencies#list",children:"this section"}),"\nto determine which Docker images to rebuild based on the changed files.\nFor instance, if you modified any of the files under the\n",(0,r.jsx)(n.a,{href:"https://github.com/broadinstitute/gatk-sv/tree/main/src/svtk",children:(0,r.jsx)(n.code,{children:"gatk-sv/src/svtk/"})}),"\ndirectory, you will need to rebuild the ",(0,r.jsx)(n.code,{children:"sv-pipeline"})," Docker image.\nYou can set the list of images to rebuild using the ",(0,r.jsx)(n.code,{children:"--targets"})," argument.\nFor instance:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"python scripts/docker/build_docker.py \\\n    --targets sv-pipeline\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You may specify multiple images to rebuild by providing a list of their names.\nFor instance, the following command builds the ",(0,r.jsx)(n.code,{children:"sv-pipeline"})," and the ",(0,r.jsx)(n.code,{children:"str"})," Docker images."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"python scripts/docker/build_docker.py \\\n    --targets sv-pipeline str\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Automatic (advanced):"}),"\nYou may refer to ",(0,r.jsx)(n.a,{href:"./images#incremental",children:"this page"})," for details on this method.\nBriefly, you may take the following steps."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"git commit"})," the changes."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Identify ",(0,r.jsx)(n.code,{children:"BASE_SHA"})," and ",(0,r.jsx)(n.code,{children:"HEAD_SHA"})," using ",(0,r.jsx)(n.code,{children:"git log"})," or GitHub.\nYou may use the following commands to get these SHAs."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'export \\\n  HEAD_SHA=$(git log -1 --pretty=format:"%H") \\\n  BASE_SHA=$(git merge-base main $(git branch --show-current))\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Note that, you may need to ",(0,r.jsx)(n.a,{href:"https://git-scm.com/docs/git-merge-base",children:"modify these commands"})," if your branch has a complicated git history."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Run the script using ",(0,r.jsx)(n.code,{children:"--base-git-commit"})," and ",(0,r.jsx)(n.code,{children:"--current-git-commit"})," instead of ",(0,r.jsx)(n.code,{children:"--targets"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"python scripts/docker/build_docker.py \\\n    --base-git-commit <BASE_SHA> \\\n    --current-git-commit <HEAD_SHA>\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Please note that ",(0,r.jsx)(n.code,{children:"--targets"})," and ",(0,r.jsx)(n.code,{children:"--base-git-commit --current-git-commit"}),"\noptions are mutually exclusive. In other words, you can either manually specify\nimages to rebuild, or let the script determine them automatically using commit SHAs;\ncombining or avoiding both options is not currently supported."]}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsxs)(n.p,{children:["Following the steps above, the script builds the specified Docker images\n",(0,r.jsx)(n.em,{children:"and all the images derived from them"}),".\nYou may add the ",(0,r.jsx)(n.code,{children:"--skip-dependent-images"})," flag to build only the explicitly specified images."]})}),"\n",(0,r.jsx)(n.h3,{id:"tag",children:(0,r.jsx)(n.code,{children:"--image-tag"})}),"\n",(0,r.jsxs)(n.p,{children:["You may use any naming convention for the Docker image\n",(0,r.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/commandline/tag/",children:"tags"}),".\nGATK-SV Docker images are tagged using the following template\n(you may refer to ",(0,r.jsx)(n.a,{href:"./automated#args",children:"this section"})," for details)."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[Date]-[Release Tag]-[Head SHA 8]\n"})}),"\n",(0,r.jsx)(n.p,{children:"For example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"--image-tag 2023-07-28-v0.28.1-beta-e70dfbd7\n"})}),"\n",(0,r.jsx)(n.h3,{id:"registry",children:(0,r.jsx)(n.code,{children:" --docker-repo"})}),"\n",(0,r.jsxs)(n.p,{children:["If you are only testing GATK-SV Docker image build,\nyou may skip this section and avoid providing ",(0,r.jsx)(n.code,{children:"--docker-repo <registry>"}),".\nHowever, if you need to push image to container registries,\nneed images for WDL testing, or need to host the images on a container registry\nother than those maintained by the GATK-SV team."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"build_docker.py"})," script automatically pushes Docker images to a container registry\nwhen ",(0,r.jsx)(n.code,{children:"--docker-repo <registry>"})," is provided, replacing ",(0,r.jsx)(n.code,{children:"<registry>"})," with the container registry you want to use.\nWhen providing this argument, ensure that you are logged into Docker with\ncredentials granting push access to the registry,\nYou may configure and set the registry as the following."]}),"\n",(0,r.jsxs)(o.A,{groupId:"cr",defaultValue:"gcr",values:[{label:"ACR",value:"acr"},{label:"GCR",value:"gcr"}],children:[(0,r.jsx)(a.A,{value:"acr",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["You may follow ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/container-registry/container-registry-get-started-portal?tabs=azure-cli",children:"these steps"}),"\nif you have not configured a container registry."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Once configured, you may set ",(0,r.jsx)(n.code,{children:"<registry>"})," in the following template."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"<REGISTRY>.azurecr.io/<REPOSITORY>/<IMAGE>\n"})}),"\n",(0,r.jsx)(n.p,{children:"Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"myregistry.azurecr.io/gatk-sv\n"})}),"\n"]}),"\n"]})}),(0,r.jsx)(a.A,{value:"gcr",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["You may follow ",(0,r.jsx)(n.a,{href:"https://cloud.google.com/artifact-registry/docs/repositories/create-repos",children:"these steps"}),"\nif you have not configured a container registry."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Once configured, you may set ",(0,r.jsx)(n.code,{children:"<registry>"})," in the following template."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"<HOST_NAME>/<REPOSITORY>/<IMAGE>\n"})}),"\n",(0,r.jsx)(n.p,{children:"Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"us.gcr.io/my-repository/gatk-sv\n"})}),"\n"]}),"\n"]})})]}),"\n",(0,r.jsx)(n.h2,{id:"post-build",children:"Post-build"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"GATK-SV docker images are mainly intended for use in WDLs.\nTherefore, it's a good practice to run the related WDLs with\nupdated images to assert if the images function as expected."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"If you were using a Linux VM to build the Docker images,\nensure you either stop or delete the VM after building the images.\nStopping the VM won't delete the disk, and you may continue to\nincur disk usage charges. If you plan on re-using the VM,\nstopping is preferred as it preserves the configuration;\notherwise, you may delete the VM and all the associated resources\n(attached disks in particular)."}),"\n"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},9365(e,n,t){t.d(n,{A:()=>o});t(6540);var s=t(4164);const r="tabItem_Ymn6";var i=t(4848);function o({children:e,hidden:n,className:t}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,s.A)(r,t),hidden:n,children:e})}}}]);